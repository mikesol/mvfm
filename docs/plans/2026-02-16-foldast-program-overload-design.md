# Design: foldAST should accept Program directly

**Issue:** #206
**Date:** 2026-02-16

## Problem

Every call site that runs a program writes `foldAST(interpreter, prog.ast.result)`. The `.ast.result` drill is pure boilerplate. Additionally, `injectInput` is copy-pasted as a local helper in ~40 test files.

## Design

### 1. `foldAST` Program overload

Add a `Program` overload to `foldAST` in `packages/core/src/fold.ts`:

```ts
export async function foldAST(interpreter: Interpreter, program: Program, state?: FoldState): Promise<unknown>;
export async function foldAST(interpreter: Interpreter, root: TypedNode, state?: FoldState): Promise<unknown>;
export async function foldAST(
  interpreter: Interpreter,
  rootOrProgram: TypedNode | Program,
  state?: FoldState,
): Promise<unknown> {
  const root = "ast" in rootOrProgram && "hash" in rootOrProgram
    ? rootOrProgram.ast.result
    : rootOrProgram as TypedNode;
  // ... existing body unchanged
}
```

Detection: `Program` has `ast` + `hash`; `TypedNode` has `kind`. No ambiguity.

### 2. `injectInput` as core export

New export from `@mvfm/core`:

```ts
export function injectInput(program: Program, input: Record<string, unknown>): Program {
  function walk(node: any): any {
    if (node === null || node === undefined || typeof node !== "object") return node;
    if (Array.isArray(node)) return node.map((n) => walk(n));
    const result: any = {};
    for (const [k, v] of Object.entries(node)) {
      result[k] = walk(v);
    }
    if (result.kind === "core/input") result.__inputData = input;
    return result;
  }
  return { ...program, ast: walk(program.ast) };
}
```

Operates at `Program` level, returns `Program` — zero drilling.

### 3. `checkCompleteness` Program overload

Same pattern as `foldAST` — add a `Program` overload that extracts `.ast.result`.

### 4. Call site updates

- **~40 test files**: replace local `injectInput` + `run()` helpers with the core export. Pattern becomes:
  - No input: `foldAST(combined, prog)`
  - With input: `foldAST(combined, injectInput(prog, { n: 40 }))`
- **handler.server.ts / fiber interpreter**: no change (operate on raw `TypedNode` sub-trees)
- **API reports** (`etc/core.api.md`, `etc/core.api.json`): regenerated by build

### 5. Non-breaking

All existing `TypedNode` call sites continue to work unchanged.

## VISION.md alignment

- §1 DX: The 4-step flow should be minimal boilerplate.
